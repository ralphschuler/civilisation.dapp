name: AI Review

on:
  pull_request:
    types:
      - opened
      - reopened
      - ready_for_review
      - synchronize
      - edited

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      COPILOT_TOKEN: ${{ secrets.COPILOT_TOKEN }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    outputs:
      final_message: ${{ steps.copilot.outputs.response || steps.run_ai.outputs.final-message }}
    steps:
      - name: Record available AI backends
        id: ai-inputs
        env:
          COPILOT_TOKEN: ${{ secrets.COPILOT_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -n "$COPILOT_TOKEN" ]; then
            echo "copilot=available" >> "$GITHUB_OUTPUT"
          else
            echo "copilot=missing" >> "$GITHUB_OUTPUT"
          fi

          if [ -n "$OPENAI_API_KEY" ]; then
            echo "openai=available" >> "$GITHUB_OUTPUT"
          else
            echo "openai=missing" >> "$GITHUB_OUTPUT"
          fi

          if [ -z "$COPILOT_TOKEN" ] && [ -z "$OPENAI_API_KEY" ]; then
            echo "::warning::Neither COPILOT_TOKEN nor OPENAI_API_KEY secrets are configured. Skipping AI review." >&2
            echo "enabled=false" >> "$GITHUB_OUTPUT"
          else
            echo "enabled=true" >> "$GITHUB_OUTPUT"
          fi

      - uses: actions/checkout@v5
        if: steps.ai-inputs.outputs.enabled == 'true'
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge

      - name: Pre-fetch base and head refs for the PR
        if: steps.ai-inputs.outputs.enabled == 'true'
        run: |
          git fetch --no-tags origin \
            ${{ github.event.pull_request.base.ref }} \
            +refs/pull/${{ github.event.pull_request.number }}/head

      - name: Summarise changed files
        if: steps.ai-inputs.outputs.enabled == 'true'
        id: changed-files
        uses: actions/github-script@v8
        with:
          github-token: ${{ github.token }}
          result-encoding: string
          script: |
            const files = await github.paginate(
              github.rest.pulls.listFiles,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                per_page: 100,
              },
            );

            const summary = files
              .map((file) => {
                const changeCount =
                  typeof file.changes === 'number' ? `, ${file.changes} changes` : '';
                return `- ${file.filename} (${file.status}${changeCount})`;
              })
              .join('\n');

            return summary || 'No file changes reported.';

      - name: Run GitHub Copilot reviewer
        if: steps.ai-inputs.outputs.enabled == 'true' && steps.ai-inputs.outputs.copilot == 'available'
        id: copilot
        continue-on-error: true
        uses: github/copilot-workflow@v1
        with:
          instructions: |
            You are reviewing PR #${{ github.event.pull_request.number }} for ${{ github.repository }}.
            Base SHA: ${{ github.event.pull_request.base.sha }}
            Head SHA: ${{ github.event.pull_request.head.sha }}

            Changed files:
            ${{ steps.changed-files.outputs.result }}

            Provide actionable review feedback that highlights bugs, risky changes, or follow-up work.
            Only discuss code introduced in this PR and be concise.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COPILOT_TOKEN: ${{ secrets.COPILOT_TOKEN }}

      - name: Run OpenAI reviewer
        if: steps.ai-inputs.outputs.enabled == 'true' && steps.ai-inputs.outputs.openai == 'available' && steps.copilot.outcome != 'success'
        id: run_ai
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt: |
            This is PR #${{ github.event.pull_request.number }} for ${{ github.repository }}.
            Base SHA: ${{ github.event.pull_request.base.sha }}
            Head SHA: ${{ github.event.pull_request.head.sha }}

            Changed files:
            ${{ steps.changed-files.outputs.result }}

            Review ONLY the changes introduced by the PR.
            Suggest any improvements, potential bugs, or issues.
            Be concise and specific in your feedback.

            Pull request title and body:
            ----
            ${{ github.event.pull_request.title }}
            ${{ github.event.pull_request.body }}

  post_feedback:
    runs-on: ubuntu-latest
    needs: review
    if: needs.review.outputs.final_message != ''
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: Report AI feedback
        uses: actions/github-script@v8
        env:
          AI_FINAL_MESSAGE: ${{ needs.review.outputs.final_message }}
        with:
          github-token: ${{ github.token }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: process.env.AI_FINAL_MESSAGE,
            });
